using System;
using System.IO;
using System.Linq;
using System.Net;
using System.Text;
using System.Web;
using System.Web.Services;
using System.Web.Services.Protocols;
using System.Xml.Linq;

#region Enums + Attribute

public enum NumericKind
{
    Int32,
    Int64
}

public enum ResponseMode
{
    SoapFault,
    Http400
}

[AttributeUsage(AttributeTargets.Method, AllowMultiple = true)]
public sealed class SoapRangeValidateAttribute : SoapExtensionAttribute
{
    public SoapRangeValidateAttribute(string paramName, NumericKind kind, string min, string max)
    {
        ParamName = paramName;
        Kind = kind;
        Min = min;
        Max = max;
    }

    public string ParamName { get; private set; }
    public NumericKind Kind { get; private set; }
    public string Min { get; private set; }
    public string Max { get; private set; }

    public string ErrorMessage { get; set; } = "Invalid request parameter.";
    public ResponseMode ResponseMode { get; set; } = ResponseMode.SoapFault;

    // If ResponseMode.Http400, return SOAP XML fault body or plain text
    public bool Http400ReturnsSoapBody { get; set; } = false;

    // Logging API
    public string LogApiUrl { get; set; } = "";
    public int LogApiTimeoutSeconds { get; set; } = 2;

    public override Type ExtensionType
    {
        get { return typeof(SoapRangeValidateExtension); }
    }

    public override int Priority { get; set; } = 1;
}

#endregion

#region REST Logger (HttpWebRequest)

internal static class RestErrorLogger
{
    public static void Log(string logApiUrl, int timeoutSeconds, string message)
    {
        if (string.IsNullOrWhiteSpace(logApiUrl))
            return;

        try
        {
            string postData = "source=" + HttpUtility.UrlEncode("ASMX-SoapExtension") +
                              "&message=" + HttpUtility.UrlEncode(message) +
                              "&timestampUtc=" + HttpUtility.UrlEncode(DateTime.UtcNow.ToString("o"));

            byte[] data = Encoding.UTF8.GetBytes(postData);

            HttpWebRequest req = (HttpWebRequest)WebRequest.Create(logApiUrl);
            req.Method = "POST";
            req.ContentType = "application/x-www-form-urlencoded";
            req.Timeout = timeoutSeconds <= 0 ? 2000 : timeoutSeconds * 1000;
            req.ContentLength = data.Length;

            using (Stream stream = req.GetRequestStream())
            {
                stream.Write(data, 0, data.Length);
            }

            using (HttpWebResponse resp = (HttpWebResponse)req.GetResponse())
            {
                // ignore response
            }
        }
        catch
        {
            // Never throw from logger
        }
    }
}

#endregion

#region SoapExtension

public sealed class SoapRangeValidateExtension : SoapExtension
{
    private sealed class Rule
    {
        public string MethodName;
        public string ParamName;
        public NumericKind Kind;
        public string Min;
        public string Max;
        public string ErrorMessage;
        public ResponseMode ResponseMode;
        public bool Http400ReturnsSoapBody;
        public string LogApiUrl;
        public int LogApiTimeoutSeconds;
    }

    private Rule _rule = new Rule();
    private Stream _oldStream;
    private MemoryStream _bufferStream;

    public override object GetInitializer(Type serviceType)
    {
        return new Rule();
    }

    public override object GetInitializer(LogicalMethodInfo methodInfo, SoapExtensionAttribute attribute)
    {
        SoapRangeValidateAttribute a = (SoapRangeValidateAttribute)attribute;

        Rule r = new Rule();
        r.MethodName = methodInfo.Name;
        r.ParamName = a.ParamName;
        r.Kind = a.Kind;
        r.Min = a.Min;
        r.Max = a.Max;
        r.ErrorMessage = a.ErrorMessage;
        r.ResponseMode = a.ResponseMode;
        r.Http400ReturnsSoapBody = a.Http400ReturnsSoapBody;
        r.LogApiUrl = a.LogApiUrl;
        r.LogApiTimeoutSeconds = a.LogApiTimeoutSeconds;

        return r;
    }

    public override void Initialize(object initializer)
    {
        _rule = (Rule)initializer;
    }

    public override Stream ChainStream(Stream stream)
    {
        _oldStream = stream;
        _bufferStream = new MemoryStream();
        return _bufferStream;
    }

    public override void ProcessMessage(SoapMessage message)
    {
        if (message.Stage != SoapMessageStage.BeforeDeserialize)
            return;

        string soapXml = ReadAllFrom(_bufferStream);

        try
        {
            if (!IsCallForMethod(soapXml, _rule.MethodName))
            {
                WriteBack(soapXml, _oldStream);
                return;
            }

            string raw = ExtractParamValue(soapXml, _rule.MethodName, _rule.ParamName);
            if (raw == null)
            {
                Fail(_rule, "Missing required parameter '" + _rule.ParamName + "'.");
                return;
            }

            raw = raw.Trim();

            if (!IsValidInteger(raw))
            {
                Fail(_rule, _rule.ErrorMessage + " (Not numeric)");
                return;
            }

            // Validate against Int32 / Int64 range first
            if (_rule.Kind == NumericKind.Int32)
            {
                if (!IsInRange(raw, "-2147483648", "2147483647"))
                {
                    Fail(_rule, _rule.ErrorMessage + " (Out of Int32 range)");
                    return;
                }
            }
            else
            {
                if (!IsInRange(raw, "-9223372036854775808", "9223372036854775807"))
                {
                    Fail(_rule, _rule.ErrorMessage + " (Out of Int64 range)");
                    return;
                }
            }

            // Validate custom min/max
            if (!IsInRange(raw, _rule.Min, _rule.Max))
            {
                Fail(_rule, _rule.ErrorMessage + " (Out of allowed range)");
                return;
            }

            // allow request
            WriteBack(soapXml, _oldStream);
        }
        catch (Exception ex)
        {
            Fail(_rule, "Invalid request. " + ex.Message);
        }
    }

    private static bool IsValidInteger(string value)
    {
        if (string.IsNullOrWhiteSpace(value))
            return false;

        int start = 0;

        if (value[0] == '+' || value[0] == '-')
        {
            if (value.Length == 1) return false;
            start = 1;
        }

        for (int i = start; i < value.Length; i++)
        {
            if (!char.IsDigit(value[i]))
                return false;
        }

        return true;
    }

    // Compares numeric strings safely (no overflow)
    private static bool IsInRange(string value, string min, string max)
    {
        if (CompareNumericStrings(value, min) < 0)
            return false;

        if (CompareNumericStrings(value, max) > 0)
            return false;

        return true;
    }

    // Returns:
    // -1 if a < b
    //  0 if a == b
    //  1 if a > b
    private static int CompareNumericStrings(string a, string b)
    {
        a = NormalizeNumber(a);
        b = NormalizeNumber(b);

        bool aNeg = a.StartsWith("-");
        bool bNeg = b.StartsWith("-");

        if (aNeg && !bNeg) return -1;
        if (!aNeg && bNeg) return 1;

        if (!aNeg && !bNeg)
        {
            // both positive
            return ComparePositive(a, b);
        }
        else
        {
            // both negative: reverse comparison
            string ap = a.Substring(1);
            string bp = b.Substring(1);
            return -ComparePositive(ap, bp);
        }
    }

    private static int ComparePositive(string a, string b)
    {
        // remove leading zeros
        a = a.TrimStart('0');
        b = b.TrimStart('0');

        if (a.Length == 0) a = "0";
        if (b.Length == 0) b = "0";

        if (a.Length < b.Length) return -1;
        if (a.Length > b.Length) return 1;

        int cmp = string.CompareOrdinal(a, b);
        if (cmp < 0) return -1;
        if (cmp > 0) return 1;
        return 0;
    }

    private static string NormalizeNumber(string v)
    {
        v = v.Trim();

        if (v.StartsWith("+"))
            v = v.Substring(1);

        // Keep "-" if negative
        if (v.StartsWith("-"))
        {
            string p = v.Substring(1).TrimStart('0');
            if (p.Length == 0) p = "0";
            return "-" + p;
        }

        v = v.TrimStart('0');
        if (v.Length == 0) v = "0";

        return v;
    }

    private static bool IsCallForMethod(string soapXml, string methodName)
    {
        XDocument doc = XDocument.Parse(soapXml, LoadOptions.None);

        XElement body = doc.Descendants().FirstOrDefault(x => x.Name.LocalName == "Body");
        if (body == null)
            return false;

        return body.Descendants().Any(x => x.Name.LocalName == methodName);
    }

    private static string ExtractParamValue(string soapXml, string methodName, string paramName)
    {
        XDocument doc = XDocument.Parse(soapXml, LoadOptions.None);

        XElement body = doc.Descendants().FirstOrDefault(x => x.Name.LocalName == "Body");
        if (body == null)
            return null;

        XElement op = body.Descendants().FirstOrDefault(x => x.Name.LocalName == methodName);
        if (op == null)
            return null;

        XElement p = op.Elements().FirstOrDefault(x => x.Name.LocalName == paramName);
        return p != null ? p.Value : null;
    }

    private static void Fail(Rule rule, string message)
    {
        // Call REST API logger
        RestErrorLogger.Log(rule.LogApiUrl, rule.LogApiTimeoutSeconds, message);

        if (rule.ResponseMode == ResponseMode.Http400)
        {
            HttpContext ctx = HttpContext.Current;
            if (ctx != null)
            {
                ctx.Response.Clear();
                ctx.Response.StatusCode = 400;

                if (rule.Http400ReturnsSoapBody)
                {
                    ctx.Response.ContentType = "text/xml; charset=utf-8";
                    ctx.Response.Write(BuildSoapFaultXml(message));
                }
                else
                {
                    ctx.Response.ContentType = "text/plain; charset=utf-8";
                    ctx.Response.Write(message);
                }

                ctx.ApplicationInstance.CompleteRequest();
                return;
            }
        }

        throw new SoapException(message, new System.Xml.XmlQualifiedName("Client", SoapException.Namespace));
    }

    private static string ReadAllFrom(MemoryStream ms)
    {
        ms.Position = 0;
        using (StreamReader sr = new StreamReader(ms, Encoding.UTF8, true, 8192, true))
        {
            return sr.ReadToEnd();
        }
    }

    private static void WriteBack(string content, Stream target)
    {
        byte[] bytes = Encoding.UTF8.GetBytes(content);
        target.SetLength(0);
        target.Write(bytes, 0, bytes.Length);
        target.Position = 0;
    }

    private static string BuildSoapFaultXml(string msg)
    {
        string safe = System.Security.SecurityElement.Escape(msg);

        return
@"<?xml version=""1.0"" encoding=""utf-8""?>
<soap:Envelope xmlns:soap=""http://schemas.xmlsoap.org/soap/envelope/"">
  <soap:Body>
    <soap:Fault>
      <faultcode>soap:Client</faultcode>
      <faultstring>" + safe + @"</faultstring>
    </soap:Fault>
  </soap:Body>
</soap:Envelope>";
    }
}

#endregion

#region Example ASMX WebService

[WebService(Namespace = "http://tempuri.org/")]
public class MyService : WebService
{
    // Your exact usage:
    [WebMethod]
    [SoapRangeValidate("id", NumericKind.Int64, "1", "9999999999",
        ErrorMessage = "Invalid id",
        ResponseMode = ResponseMode.Http400,
        Http400ReturnsSoapBody = false,
        LogApiUrl = "https://your-domain/api/logs",
        LogApiTimeoutSeconds = 2)]
    public string test123(long id)
    {
        return "SUCCESS";
    }

    // SOAP Fault example:
    [WebMethod]
    [SoapRangeValidate("age", NumericKind.Int32, "0", "120",
        ErrorMessage = "Invalid age",
        ResponseMode = ResponseMode.SoapFault,
        LogApiUrl = "https://your-domain/api/logs",
        LogApiTimeoutSeconds = 2)]
    public string testInt(int age)
    {
        return "SUCCESS";
    }
}

#endregion
